# 1. 管理k8s核心资源的三种基本方法

- 陈述式管理方法--主要依赖命令行cli工具进行管理
- 声明式管理方法--主要依赖统一资源配置清单（manifest）进行管理
- GUI式管理方法--主要依赖图形化操作界面（web页面）进行管理



## 1.1. 陈述式管理

### 1.1.1. 管理名称空间资源

```bash
# 查询名称空间
[root@hdss7-21 conf]# kubectl get namespace （kubectl get ns）
NAME              STATUS   AGE
default           Active   2d5h
kube-node-lease   Active   2d5h
kube-public       Active   2d5h
kube-system       Active   2d5h

# 获取default名称空间的所有资源
[root@hdss7-21 conf]# kubectl get all -n default (kubectl get all)
NAME                 READY   STATUS    RESTARTS   AGE
pod/nginx-ds-8sqnt   1/1     Running   1          21h
pod/nginx-ds-w8kh5   1/1     Running   1          21h


NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   192.168.0.1   <none>        443/TCP   2d5h

NAME                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
daemonset.apps/nginx-ds   2         2         2       2            2           <none>          21h

# 创建名称空间
[root@hdss7-21 conf]# kubectl create namespace app (kubectl create ns app)
namespace/app created
[root@hdss7-21 conf]# kubectl get namespace
NAME              STATUS   AGE
app               Active   41s
default           Active   2d5h
kube-node-lease   Active   2d5h
kube-public       Active   2d5h
kube-system       Active   2d5h

# 删除名称空间
kub ^H[root@hdss7-21 conf]# kubectl delete namespace app (kubectl delete ns app)
namespace "app" deleted
k[root@hdss7-21 conf]# kubectl get ns
NAME              STATUS   AGE
default           Active   2d5h
kube-node-lease   Active   2d5h
kube-public       Active   2d5h
kube-system       Active   2d5h

```

### 1.1.2. 管理Deployment资源

```bash
# 在名称空间kube-public下创建名字为nginx-dp的deployment
[root@hdss7-21 conf]# kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public
deployment.apps/nginx-dp created

# 获取名称空间kube-public下的deployment
[root@hdss7-21 conf]# kubectl get deployment -n kube-public
NAME       READY   UP-TO-DATE   AVAILABLE   AGE
nginx-dp   1/1     1            1           11s

# 详细查看
[root@hdss7-21 conf]# kubectl describe deployment nginx-dp -n kube-public
Name:                   nginx-dp
Namespace:              kube-public
CreationTimestamp:      Thu, 05 Nov 2020 15:27:42 +0800
Labels:                 app=nginx-dp
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               app=nginx-dp
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=nginx-dp
  Containers:
   nginx:
    Image:        harbor.od.com/public/nginx:v1.7.9
    Port:         <none>
    Host Port:    <none>
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   nginx-dp-5dfc689474 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  28m   deployment-controller  Scaled up replica set nginx-dp-5dfc689474 to 1
```

### 1.1.3. 查看pod资源

```bash
# 获取名称空间kube-public下的pod
[root@hdss7-21 conf]# kubectl get pods -n kube-public
NAME                        READY   STATUS    RESTARTS   AGE
nginx-dp-5dfc689474-l2mgg   1/1     Running   0          23s

# 以扩展的方式展示pod相关信息
[root@hdss7-21 conf]# kubectl get pods -n kube-public -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE                NOMINATED NODE   READINESS GATES
nginx-dp-5dfc689474-l2mgg   1/1     Running   0          16m   172.7.21.3   hdss7-21.host.com   <none>           <none>
```

### 1.1.4. 进入pod资源

```bash
# kubectl 进入
[root@hdss7-21 conf]# kubectl exec -it nginx-dp-5dfc689474-l2mgg bash -n kube-public
root@nginx-dp-5dfc689474-l2mgg:/# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
8: eth0@if9: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue state UP 
    link/ether 02:42:ac:07:15:03 brd ff:ff:ff:ff:ff:ff
    inet 172.7.21.3/24 brd 172.7.21.255 scope global eth0
       valid_lft forever preferred_lft forever
root@nginx-dp-5dfc689474-l2mgg:/# 

# docker 进入
[root@hdss7-21 conf]# docker ps -a| grep nginx-dp
f873066cc03c        84581e99d807                        "nginx -g 'daemon of…"   53 minutes ago      Up 53 minutes                                  k8s_nginx_nginx-dp-5dfc689474-l2mgg_kube-public_a0e9a8d9-b409-4571-ade3-cc070041d5c4_0
c165f09ce3a9        harbor.od.com/public/pause:latest   "/pause"                 53 minutes ago      Up 53 minutes                                  k8s_POD_nginx-dp-5dfc689474-l2mgg_kube-public_a0e9a8d9-b409-4571-ade3-cc070041d5c4_0
# 容器id可以取前几位
[root@hdss7-21 conf]# docker exec -it f873 bash
root@nginx-dp-5dfc689474-l2mgg:/# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
8: eth0@if9: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue state UP 
    link/ether 02:42:ac:07:15:03 brd ff:ff:ff:ff:ff:ff
    inet 172.7.21.3/24 brd 172.7.21.255 scope global eth0
       valid_lft forever preferred_lft forever

```

### 1.1.5. 删除pod资源（重启）

```bash
# 查看当前pod
[root@hdss7-21 conf]# kubectl get pods -n kube-public -o wide
NAME                        READY   STATUS    RESTARTS   AGE    IP           NODE                NOMINATED NODE   READINESS GATES
nginx-dp-5dfc689474-l2mgg   1/1     Running   0          167m   172.7.21.3   hdss7-21.host.com   <none>           <none>
# 删除
[root@hdss7-21 conf]# kubectl delete pod nginx-dp-5dfc689474-l2mgg -n kube-public
pod "nginx-dp-5dfc689474-l2mgg" deleted
# 再次查看，观察变化
[root@hdss7-21 conf]# kubectl get pods -n kube-public -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE                NOMINATED NODE   READINESS GATES
nginx-dp-5dfc689474-4xgts   1/1     Running   0          16s   172.7.22.3   hdss7-22.host.com   <none>           <none>

# 强制删除 --force --grace-period=0
```

### 1.1.6. 删除Deployment

```bash
[root@hdss7-21 conf]# kubectl get all -n kube-public
NAME                            READY   STATUS    RESTARTS   AGE
pod/nginx-dp-5dfc689474-4xgts   1/1     Running   0          10m




NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx-dp   1/1     1            1           177m

NAME                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-dp-5dfc689474   1         1         1       177m




[root@hdss7-21 conf]# kubectl delete deployment nginx-dp -n kube-public
deployment.extensions "nginx-dp" deleted
[root@hdss7-21 conf]# kubectl get all -n kube-public
NAME                            READY   STATUS        RESTARTS   AGE

```

### 1.1.7. 管理service资源

```bash
# 创建Service
[root@hdss7-21 conf]# kubectl expose deployment nginx-dp --port=80 -n kube-public
service/nginx-dp exposed

# 查看
[root@hdss7-22 ~]# kubectl get all -n kube-public
NAME                            READY   STATUS    RESTARTS   AGE
pod/nginx-dp-5dfc689474-rh49f   1/1     Running   0          17m


NAME               TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)   AGE
service/nginx-dp   ClusterIP   192.168.159.220   <none>        80/TCP    14m


NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx-dp   1/1     1            1           17m

NAME                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-dp-5dfc689474   1         1         1       17m

# 查看代理情况
[root@hdss7-22 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.0.1:443 nq
  -> 10.4.7.21:6443               Masq    1      0          0         
  -> 10.4.7.22:6443               Masq    1      0          0         
TCP  192.168.159.220:80 nq
  -> 172.7.21.3:80                Masq    1      0          0    
  
# 通过service 192.168.159.220 访问（在pod启动的那台节点上）
[root@hdss7-21 ~]# curl 192.168.159.220
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>

# 扩缩容
[root@hdss7-21 ~]# kubectl scale deployment nginx-dp --replicas=2 -n kube-public
deployment.extensions/nginx-dp scaled
[root@hdss7-21 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.0.1:443 nq
  -> 10.4.7.21:6443               Masq    1      0          0         
  -> 10.4.7.22:6443               Masq    1      0          0         
TCP  192.168.159.220:80 nq
  -> 172.7.21.3:80                Masq    1      0          0         
  -> 172.7.22.3:80                Masq    1      0          0      
  
# 至此在21和22上都可以通过service访问了
```

### 1.1.8. 查看Service

```bash
[root@hdss7-22 ~]# kubectl describe svc nginx-dp -n kube-public
Name:              nginx-dp
Namespace:         kube-public
Labels:            app=nginx-dp
Annotations:       <none>
Selector:          app=nginx-dp
Type:              ClusterIP
IP:                192.168.159.220
Port:              <unset>  80/TCP
TargetPort:        80/TCP
Endpoints:         172.7.21.3:80,172.7.22.3:80
Session Affinity:  None
Events:            <none>

```

